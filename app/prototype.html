<html>
  <head>
    <!-- High Charts -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>-->
    <!-- <srcipt type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.6/angular.min.js"></script> -->

    <!-- Highcharts -->
    <!--<script src="http://code.highcharts.com/stock/highstock.js"></script>-->
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">

      // Load the Visualization API and the piechart package.
      google.load('visualization', '1.0');//, {'packages':['corechart','table']});

      jQuery.noConflict();

      jQuery(document).ready(function($) {

        // Set a callback to run when the Google Visualization API is loaded.
        google.setOnLoadCallback(drawCharts);

        // global variables
        var allData = {};
        var chartTitle = '';
        var renderToDiv = '';

        // Callback that creates and populates a data table,
        // instantiates the pie chart, passes in the data and
        // draws it.
        function drawCharts() {
          var sheet = "https://docs.google.com/spreadsheet/ccc?key=0AqWHu14u074CdExaZ21PMDNtdVJQbHJncWk3c1c2SlE&usp=drive_web&sheet=Data";
          var query = "select D, E, A, B where D is not null AND F = ";
          var gQuery1 = new google.visualization.Query(sheet);
          
          chartTitle = "Feature";
          renderToDiv = 'feature';
          gQuery1.setQuery(query + '"' + chartTitle +'"');
          gQuery1.send(chartFeatureResponse);

          var gQuery2 = new google.visualization.Query(sheet);
          chartTitle = "Defect";
          renderToDiv = 'defect';
          gQuery2.setQuery(query + '"' + chartTitle + '"');
          gQuery2.send(chartDefectResponse);
        }

        function getDataFromResponse(response) {
          var dataTable = response.getDataTable();
          //console.log(JSON.stringify(data));

          //var headers = getSheetHeadersAsCsv(dataTable);
          //console.log(headers);

          var data = google.visualization.dataTableToCsv(dataTable);
          data = parseData(data);
          console.log(data);
          return data;
        }

        function isResponseError(response) {
          if (response.isError()) {
            alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
            return true;
          }
          return false;
        }

        function chartFeatureResponse(response) {
          if (isResponseError(response)) {
            return;
          }

          var chartInfo = {
            qResponse: response,
            cTitle: 'Feature',
            cDiv: 'feature'
          };

          drawChart(chartInfo);

          // var data = getDataFromResponse(response);

          //var table = new google.visualization.Table(document.getElementById('columnchart'));
          //table.draw(dataTable, null);

          //var dataCsv = headers + "\n" + data;

          // var options = getOptionsForChart('Feature', 'feature', data);
          // var chart = new Highcharts.Chart(options);
        }

        function chartDefectResponse(response) {
          if (isResponseError(response)) {
            return;
          }

          var chartInfo = {
            qResponse: response,
            cTitle: 'Defect',
            cDiv: 'defect'
          };

          drawChart(chartInfo);
        }

        function drawChart(chartInfo) {
          var chart = new Highcharts.Chart(getOptionsForChart(chartInfo.cTitle, chartInfo.cDiv, getDataFromResponse(chartInfo.qResponse)));
        }

        function getOptionsForChart(title, div, data) {
          return {
            chart: {
              renderTo: div,
              type: 'line'
            },
            title: {
              text: title + ' Control Chart'
            },
            xAxis: {
              title: {
                text: 'End Dates'
              },
              categories: data.endDates
            },
            yAxis: {
              title: {
                text: 'Lead Time'
              }
              // ,
              // plotLines: {
              //   color: 'red',
              //   label: {
              //     text: 'Average Lead Time'
              //   },
              //   value: data.avgLeadTime
              // }
            },
            series: [{
              name: 'Lead Time',
              data: data.leadTimes
            }]

          };
        }

        function parseData(csv) {
          var data = {};
          data.endDates = [];
          data.leadTimes = [];

          var lines = csv.split("\n");
          lines = popLastIndexOfArrayIfEmpty(lines);

          var str = "";
          for (var i in lines) {
            var line = lines[i].split(",");
            var obj = {};
            obj.y = parseInt(line[1]);
            obj.name = line[2] + ' - ' + line[3];
            data.endDates.push(line[0]);
            data.leadTimes.push(obj);
          }
          // data.avgLeadTime = line[4];
          return data;
        };

        function popLastIndexOfArrayIfEmpty(arry) {
          if (arry[arry.length] == "" || arry[arry.length] == null) {
            arry.pop();
          }
          return arry;
        }

        function getSheetHeadersAsCsv(data) {
          var headers = "";
          var numOfCols = data.getNumberOfColumns();
          for (var i=0; i<numOfCols; i++) {
            if (numOfCols != (i+1)) {
              headers = headers + data.getColumnLabel(i) + ",";
            } else {
              headers = headers + data.getColumnLabel(i);
            }
          }
          return headers;
        }
       
      });



    </script>
  </head>

  <body>
    <!--Div that will hold the chart-->
    <div id="feature"></div>
    <div id="defect"></div>
  </body>
</html>